const { sampleAuthors, sampleProjects, sampleInsights } = require('./seed-data');
const { registerRebuildTrigger } = require('./rebuild-trigger');

module.exports = {
  /**
   * An asynchronous register function that runs before
   * your application is initialized.
   *
   * This gives you an opportunity to extend code.
   */
  register(/*{ strapi }*/) {},

  /**
   * An asynchronous bootstrap function that runs before
   * your application gets started.
   *
   * This gives you an opportunity to set up your data model,
   * run jobs, or perform some special logic.
   */
  async bootstrap({ strapi }) {
    // Check if we should seed data (only in development)
    if (process.env.NODE_ENV !== 'production' && process.env.SEED_DATA === 'true') {
      console.log('üå± Seeding sample data...');

      try {
        // Check if data already exists
        const existingProjects = await strapi.entityService.findMany('api::project.project', {
          limit: 1,
        });

        if (!existingProjects || existingProjects.length === 0) {
          // Create sample projects
          console.log('üìÅ Creating sample projects...');
          for (const projectData of sampleProjects) {
            await strapi.entityService.create('api::project.project', {
              data: {
                ...projectData,
                slug: projectData.title
                  .toLowerCase()
                  .replace(/[^a-z0-9]+/g, '-')
                  .replace(/(^-|-$)/g, ''),
                publishedAt: new Date().toISOString(),
              },
            });
            console.log(`  ‚úÖ Created: ${projectData.title}`);
          }
        } else {
          console.log('üìÅ Projects already exist, skipping...');
        }

        // Check if authors exist
        const existingAuthors = await strapi.entityService.findMany('api::author.author', {
          limit: 1,
        });

        let authors = [];
        if (!existingAuthors || existingAuthors.length === 0) {
          // Create sample authors
          console.log('‚úçÔ∏è  Creating sample authors...');
          for (const authorData of sampleAuthors) {
            const author = await strapi.entityService.create('api::author.author', {
              data: authorData,
            });
            authors.push(author);
            console.log(`  ‚úÖ Created: ${authorData.name}`);
          }
        } else {
          console.log('‚úçÔ∏è  Authors already exist, skipping...');
          authors = await strapi.entityService.findMany('api::author.author', {
            limit: 10,
          });
        }

        // Check if insights exist
        const existingInsights = await strapi.entityService.findMany('api::insight.insight', {
          limit: 1,
        });

        if (!existingInsights || existingInsights.length === 0) {
          // Create sample insights with author relations
          console.log('üìù Creating sample insights...');
          const authorMap = {
            'Sarah Wijaya - Interior Designer': authors[0]?.id,
            'Michael Chen - Design Consultant': authors[1]?.id,
            'Dina Putri - Budget Interior Specialist': authors[2]?.id,
            'Rina Kusuma - Color Consultant': authors[3]?.id,
          };

          for (const insightData of sampleInsights) {
            const authorId = authorMap[insightData.author] || authors[0]?.id;

            await strapi.entityService.create('api::insight.insight', {
              data: {
                ...insightData,
                author: authorId,
                slug: insightData.title
                  .toLowerCase()
                  .replace(/[^a-z0-9]+/g, '-')
                  .replace(/(^-|-$)/g, ''),
                publishedAt: new Date().toISOString(),
              },
            });
            console.log(`  ‚úÖ Created: ${insightData.title}`);
          }
        } else {
          console.log('üìù Insights already exist, skipping...');
        }

        // Check if footer exists
        const existingFooter = await strapi.entityService.findMany('api::footer.footer');

        if (!existingFooter) {
          // Create default footer
          console.log('ü¶∂ Creating default footer...');
          await strapi.entityService.create('api::footer.footer', {
            data: {
              description: 'Solusi desain interior lengkap, personal, dan tanpa ribet. Dari konsultasi hingga furniture, kami handle semuanya.',
              phone: '+62 853-9898-9810',
              email: 'hello@sjdinterior.com',
              address: 'Bogor Outer Ring Rd Blok Mulia 1 No.55\nCibuluh, Bogor Utara, Bogor 16151',
              working_hours: 'Senin - Sabtu: 09:00 - 18:00\nMinggu: Tutup',
              navigation_links: [
                { label: 'Beranda', url: '/' },
                { label: 'Alur Kerja', url: '/alur-kerja' },
                { label: 'Portofolio', url: '/portfolio' },
                { label: 'Insight', url: '/insight' },
                { label: 'Hubungi Kami', url: '/hubungi-kami' },
              ],
              service_links: [
                { label: 'Desain Interior Rumah', url: '/portfolio' },
                { label: 'Desain Interior Apartemen', url: '/portfolio' },
                { label: 'Desain Interior Kantor', url: '/portfolio' },
                { label: 'Desain Interior Komersial', url: '/portfolio' },
                { label: 'Custom Furniture', url: '/portfolio' },
              ],
              social_links: [
                {
                  platform: 'Instagram',
                  url: 'https://instagram.com/sjdinterior',
                  icon_path: 'M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z',
                },
                {
                  platform: 'TikTok',
                  url: 'https://tiktok.com/@sjdinterior',
                  icon_path: 'M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z',
                },
                {
                  platform: 'YouTube',
                  url: 'https://youtube.com/@sjdinterior',
                  icon_path: 'M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z',
                },
              ],
              cta_title: 'Mulai Proyek Anda',
              cta_description: 'Konsultasi gratis untuk wujudkan interior impian Anda.',
              cta_button_text: 'Konsultasi Gratis',
              cta_button_url: 'https://wa.me/6285398989810?text=Halo%20SJD%20Interior%2C%20saya%20ingin%20berkonsultasi%20tentang%20proyek%20interior%20saya.',
              copyright_text: 'SJD Interior Studio. All rights reserved.',
              developer_name: 'LIETRIA Studio',
              developer_url: 'https://lietria.com',
            },
          });
          console.log('  ‚úÖ Created default footer');
        } else {
          console.log('ü¶∂ Footer already exists, skipping...');
        }

        // Check if stats exist
        const existingStats = await strapi.entityService.findMany('api::stats.stats');

        if (!existingStats) {
          // Create default stats
          console.log('üìä Creating default stats...');
          await strapi.entityService.create('api::stats.stats', {
            data: {
              stats1: {
                value: '500+',
                label: 'Proyek Selesai',
              },
              stats2: {
                value: '300+',
                label: 'Klien Puas',
              },
              stats3: {
                value: '15+',
                label: 'Tahun Pengalaman',
              },
              stats4: {
                value: '98%',
                label: 'Tingkat Kepuasan',
              },
            },
          });
          console.log('  ‚úÖ Created default stats');
        } else {
          console.log('üìä Stats already exist, skipping...');
        }

        console.log('‚úÖ Seed process completed!');
      } catch (error) {
        console.error('‚ùå Error seeding data:', error.message);
      }
    }

    // Configure API permissions for public access
    try {
      const publicRole = await strapi.query('plugin::users-permissions.role').findOne({
        where: { type: 'public' },
      });

      if (publicRole) {
        // Enable find and findOne for projects and insights
        const actionsToEnable = [
          'api::project.project.find',
          'api::project.project.findOne',
          'api::insight.insight.find',
          'api::insight.insight.findOne',
          'api::author.author.find',
          'api::author.author.findOne',
          'api::site-setting.site-setting.find',
          'api::footer.footer.find',
          'api::contact-info.contact-info.find',
          'api::stats.stats.find',
          'api::website-logos.website-logos.find',
          'api::faq.faq.find',
          'api::faq.faq.findOne',
          'api::navigation.navigation.find',
          'api::homepage-gallery.homepage-gallery.find',
          'api::workflow-hero.workflow-hero.find',
          'api::portfolio-category.portfolio-category.find',
          'api::portfolio-category.portfolio-category.findOne',
        ];

        for (const actionPath of actionsToEnable) {
          const permission = await strapi.query('plugin::users-permissions.permission').findOne({
            where: {
              role: publicRole.id,
              action: actionPath,
            },
          });

          if (permission && !permission.enabled) {
            await strapi.query('plugin::users-permissions.permission').update({
              where: { id: permission.id },
              data: { enabled: true },
            });
            console.log(`‚úÖ Enabled public access: ${actionPath}`);
          } else if (permission) {
            console.log(`‚ÑπÔ∏è  Already enabled: ${actionPath}`);
          } else {
            console.log(`‚ö†Ô∏è  Permission not found: ${actionPath}`);
          }
        }
      }
    } catch (error) {
      console.error('‚ùå Error configuring permissions:', error.message);
      console.error(error);
    }

    // Register rebuild trigger for automatic frontend updates
    registerRebuildTrigger(strapi);
  },
};
