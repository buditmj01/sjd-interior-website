---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/common/Header.astro';
import Footer from '../../components/common/Footer.astro';
import CTASection from '../../components/common/CTASection.astro';
import FAQSection from '../../components/common/FAQSection.astro';
import PortfolioCard from '../../components/common/PortfolioCard.astro';
import Stats from '../../components/home/Stats.astro';
import { getProjects, getImageUrl, getPortfolioCategories } from '../../lib/strapi';

// Fetch projects from Strapi (Fetching more for client-side filtering)
let portfolios = [];
try {
  const response = await getProjects({ 'pagination[limit]': 16, 'sort[0]': 'createdAt:desc' }); // Increased limit for 8 rows x 2 cols
  portfolios = response.data?.map((project) => ({
    title: project.attributes.title,
    category: project.attributes.category?.data?.attributes?.label || 'Uncategorized',
    categorySlug: project.attributes.category?.data?.attributes?.slug || 'uncategorized',
    location: project.attributes.location || 'Indonesia',
    area: project.attributes.area_size || '-',
    style: project.attributes.theme || 'Modern Minimalis',
    image: getImageUrl(project.attributes.featured_image, 'medium') || '/images/insight-card.jpg',
    slug: project.attributes.slug,
    createdAt: project.attributes.createdAt
  })) || [];
} catch (error) {
  console.error('Error fetching projects:', error);
  // Fallback to mock data
  portfolios = Array(16).fill(null).map((_, i) => ({
    title: `Modern Tropical House ${i + 1}`,
    category: i % 3 === 0 ? "Rumah" : (i % 3 === 1 ? "Kantor" : "Komersial"),
    location: "Jakarta Selatan",
    area: "350 mÂ²",
    style: "Modern Minimalis",
    image: "/images/insight-card.jpg",
    slug: `project-${i + 1}`,
    createdAt: new Date(Date.now() - i * 86400000).toISOString()
  }));
}

// Fetch categories from Strapi
let categories = [{ id: 'semua', label: 'Semua', slug: 'semua' }];
try {
  const categoriesResponse = await getPortfolioCategories();
  if (categoriesResponse && Array.isArray(categoriesResponse)) {
    const dynamicCategories = categoriesResponse.map((cat) => ({
      id: cat.attributes.slug.toLowerCase(),
      label: cat.attributes.label,
      slug: cat.attributes.slug.toLowerCase()
    }));
    categories = [{ id: 'semua', label: 'Semua', slug: 'semua' }, ...dynamicCategories];
  }
} catch (error) {
  console.error('Error fetching categories:', error);
  // Fallback to default categories
  categories = [
    { id: 'semua', label: 'Semua', slug: 'semua' },
    { id: 'rumah', label: 'Rumah', slug: 'rumah' },
    { id: 'kantor', label: 'Kantor', slug: 'kantor' },
    { id: 'komersial', label: 'Komersial', slug: 'komersial' }
  ];
}

const sortOptions = [
  { id: 'latest', label: 'Terbaru' },
  { id: 'oldest', label: 'Terlama' }
];
---

<BaseLayout
  title="Portfolio - SJD Interior"
  description="Lihat koleksi proyek interior terbaik dari SJD Interior"
  jsonLd={{
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": "Portfolio - SJD Interior",
    "description": "Lihat koleksi proyek interior terbaik dari SJD Interior",
    "url": "https://sjdinterior.com/portfolio",
    "mainEntity": {
      "@type": "ItemList",
      "itemListElement": portfolios.slice(0, 10).map((p: any, i: number) => ({
        "@type": "ListItem",
        "position": i + 1,
        "name": p.title,
        "url": `https://sjdinterior.com/portfolio/${p.slug}`
      }))
    }
  }}
>
  <Header />
  
  <main>
    <!-- Hero Section -->
    <section class="relative pt-32 md:pt-36 lg:pt-44 pb-6 md:pb-10 lg:pb-16 bg-white">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px] text-center md:text-left">
        <h1 class="text-[48px] md:text-[72px] lg:text-[128px] font-light text-black mb-4 md:mb-6 lg:mb-12 mx-auto md:mx-0" style="letter-spacing: -2.4px; line-height: 98.83%;">
          Koleksi Karya Pilihan Kami.
        </h1>
      </div>
    </section>

    <!-- Filter & Sort Section -->
    <section class="pt-6 pb-5 md:pt-8 md:pb-6 lg:pt-10 lg:pb-8 bg-white sticky top-[60px] md:top-[80px] z-30 shadow-sm md:shadow-none transition-all duration-300 border-b border-[#e5e5e5]">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px]">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 md:gap-6">

          <!-- Left: Category Filters -->
          {categories.length <= 5 ? (
            <div class="flex gap-2 overflow-x-auto scrollbar-hide -mx-6 px-6 md:mx-0 md:px-0" id="category-filters">
              {categories.map((cat) => (
                <button
                  data-category-filter={cat.id}
                  class={`filter-btn px-4 py-2 font-medium rounded-full transition-all text-[13px] md:text-[14px] whitespace-nowrap ${
                    cat.id === 'semua'
                    ? 'bg-black border-black text-white active-filter shadow-md hover:text-white hover:bg-black'
                    : 'border border-[#e0e5e5] text-[#666] hover:border-black hover:text-black bg-white'
                  }`}
                >
                  {cat.label}
                </button>
              ))}
            </div>
          ) : (
            <div class="relative category-dropdown" id="category-dropdown">
              <button
                id="category-trigger"
                class="appearance-none flex items-center gap-2 pl-4 pr-8 py-2 bg-white border border-[#e5e5e5] rounded-full text-[13px] md:text-[14px] font-medium text-black cursor-pointer transition-all hover:border-[#999]"
              >
                <span class="selected-category-label">Semua</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="absolute right-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-black pointer-events-none transition-transform duration-300" id="category-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>

              <div
                id="category-menu"
                class="absolute left-0 top-full mt-2 w-full min-w-[160px] bg-white border border-[#e5e5e5] rounded-[20px] overflow-hidden opacity-0 invisible transition-all duration-200 transform origin-top scale-95 shadow-xl max-h-[300px] overflow-y-auto"
              >
                {categories.map((cat) => (
                  <button
                    data-category-filter={cat.id}
                    class="filter-btn w-full text-left block px-4 py-2.5 text-[13px] md:text-[14px] font-medium transition-colors hover:bg-gray-50 text-[#333]"
                  >
                    {cat.label}
                  </button>
                ))}
              </div>
            </div>
          )}

          <!-- Right: Sort & Results Count -->
          <div class="flex items-center gap-4 md:gap-6 px-6 md:px-0 -mx-6 md:mx-0">
            <!-- Sort Dropdown -->
            <div class="flex items-center gap-2">
              <div class="relative sort-dropdown">
                <button
                  id="sort-trigger"
                  class="appearance-none flex items-center gap-2 pl-3 pr-8 py-1.5 bg-white border border-[#e5e5e5] rounded-full text-[13px] md:text-[14px] font-medium text-black cursor-pointer transition-all hover:border-[#999]"
                >
                  <span class="selected-sort-label">Terbaru</span>
                  <svg xmlns="http://www.w3.org/2000/svg" class="absolute right-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-black pointer-events-none transition-transform duration-300" id="sort-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>

                <div
                  id="sort-menu"
                  class="absolute right-0 top-full mt-2 w-full min-w-[120px] bg-white border border-[#e5e5e5] rounded-[20px] overflow-hidden opacity-0 invisible transition-all duration-200 transform origin-top scale-95 shadow-xl"
                >
                  {sortOptions.map((opt) => (
                    <button
                      data-sort-val={opt.id}
                      class="w-full text-left block px-4 py-2.5 text-[13px] md:text-[14px] font-medium transition-colors hover:bg-gray-50 sort-btn text-[#333]"
                    >
                      {opt.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <!-- Divider -->
            <div class="w-px h-4 bg-[#e5e5e5]"></div>

            <!-- Results Count -->
            <p class="text-[13px] md:text-[14px] text-[#666] whitespace-nowrap" id="results-count">
              <span class="font-medium text-black" id="count-number">{portfolios.length}</span> proyek
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Portfolio Grid -->
    <section class="py-8 md:py-16 bg-white min-h-screen">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px]">
        <!-- Mobile 2 cols, Tablet 2 cols, Desktop 4 cols -->
        <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-5 lg:gap-6 mb-8 portfolio-grid">
          {portfolios.map((portfolio) => (
            <div class="portfolio-card-wrapper" data-slug={portfolio.slug} style="opacity:1">
              <PortfolioCard {...portfolio} />
            </div>
          ))}
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16 md:py-24">
          <svg class="w-16 h-16 md:w-20 md:h-20 mx-auto mb-4 text-[#ddd]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
          </svg>
          <h3 class="text-xl md:text-2xl font-light text-[#666] mb-2">Tidak ada proyek ditemukan</h3>
          <p class="text-[14px] md:text-[15px] text-[#999]">Coba ubah filter atau kategori</p>
        </div>

        <div class="flex justify-center items-center gap-2 mb-6 md:mb-8 hidden" id="pagination-dots">
          <div class="w-2 h-2 md:w-2.5 md:h-2.5 bg-black rounded-full transition-all hover:scale-125 cursor-pointer"></div>
          <div class="w-2 h-2 md:w-2.5 md:h-2.5 bg-[#e0e0e0] rounded-full transition-all hover:bg-[#ccc] cursor-pointer"></div>
          <div class="w-2 h-2 md:w-2.5 md:h-2.5 bg-[#e0e0e0] rounded-full transition-all hover:bg-[#ccc] cursor-pointer"></div>
        </div>

        <div class="text-center mb-8 md:mb-10 lg:mb-12 hidden" id="load-more-container">
          <button class="inline-flex items-center gap-2 px-8 md:px-10 py-3 md:py-3.5 text-[15px] md:text-[16px] font-medium text-black border-2 border-black rounded-full hover:bg-black hover:text-white transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
            <span>Muat Lebih Banyak</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
        </div>
      </div>
    </section>

    <!-- Stats Section (Own container inside) -->
    <Stats />

    <!-- FAQ Section -->
    <FAQSection />

    <!-- CTA Section -->
    <CTASection />
  </main>

  <Footer />

  <script>
    import gsap from 'gsap';

    function initPortfolioFilters() {
      const filterBtns = document.querySelectorAll('.filter-btn');
      const sortBtns = document.querySelectorAll('.sort-btn');
      const grid = document.querySelector('.portfolio-grid');
      const cards = Array.from(document.querySelectorAll('.portfolio-card-wrapper'));
      const sortLabel = document.querySelector('.selected-sort-label');
      
      let currentCategory = 'semua';
      let currentSort = 'latest';

      // Read from URL on load
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('category')) currentCategory = urlParams.get('category');
      if (urlParams.has('sort')) currentSort = urlParams.get('sort');

      const sortTrigger = document.getElementById('sort-trigger');
      const sortMenu = document.getElementById('sort-menu');
      const sortArrow = document.getElementById('sort-arrow');
      let isSortOpen = false;

      const categoryTrigger = document.getElementById('category-trigger');
      const categoryMenu = document.getElementById('category-menu');
      const categoryArrow = document.getElementById('category-arrow');
      const categoryLabel = document.querySelector('.selected-category-label');
      let isCategoryOpen = false;

      // Toggle Sort Dropdown
      if (sortTrigger && sortMenu) {
        sortTrigger.addEventListener('click', (e) => {
          e.stopPropagation();
          isSortOpen = !isSortOpen;
          toggleSortMenu(isSortOpen);
          if (isCategoryOpen) {
            isCategoryOpen = false;
            toggleCategoryMenu(false);
          }
        });
      }

      // Toggle Category Dropdown
      if (categoryTrigger && categoryMenu) {
        categoryTrigger.addEventListener('click', (e) => {
          e.stopPropagation();
          isCategoryOpen = !isCategoryOpen;
          toggleCategoryMenu(isCategoryOpen);
          if (isSortOpen) {
            isSortOpen = false;
            toggleSortMenu(false);
          }
        });
      }

      // Close when clicking outside
      document.addEventListener('click', () => {
        if (isSortOpen) {
          isSortOpen = false;
          toggleSortMenu(false);
        }
        if (isCategoryOpen) {
          isCategoryOpen = false;
          toggleCategoryMenu(false);
        }
      });

      function toggleSortMenu(open) {
        if (open && sortMenu && sortArrow) {
          sortMenu.classList.remove('opacity-0', 'invisible', 'scale-95');
          sortMenu.classList.add('opacity-100', 'visible', 'scale-100');
          sortArrow.classList.add('rotate-180');
        } else if (sortMenu && sortArrow) {
          sortMenu.classList.add('opacity-0', 'invisible', 'scale-95');
          sortMenu.classList.remove('opacity-100', 'visible', 'scale-100');
          sortArrow.classList.remove('rotate-180');
        }
      }

      function toggleCategoryMenu(open) {
        if (open && categoryMenu && categoryArrow) {
          categoryMenu.classList.remove('opacity-0', 'invisible', 'scale-95');
          categoryMenu.classList.add('opacity-100', 'visible', 'scale-100');
          categoryArrow.classList.add('rotate-180');
        } else if (categoryMenu && categoryArrow) {
          categoryMenu.classList.add('opacity-0', 'invisible', 'scale-95');
          categoryMenu.classList.remove('opacity-100', 'visible', 'scale-100');
          categoryArrow.classList.remove('rotate-180');
        }
      }

      function updateUI(isInitial = false) {
        // Update filter buttons
        filterBtns.forEach(btn => {
          const cat = btn.getAttribute('data-category-filter');
          if (cat === currentCategory) {
            btn.classList.add('bg-black', 'text-white', 'border-black', 'active-filter', 'shadow-md', 'hover:text-white', 'hover:bg-black');
            btn.classList.remove('bg-white', 'text-[#666]', 'text-black', 'border-[#e0e0e0]', 'hover:text-black');
          } else {
            btn.classList.remove('bg-black', 'text-white', 'border-black', 'active-filter', 'shadow-md', 'hover:text-white', 'hover:bg-black');
            btn.classList.add('bg-white', 'text-[#666]', 'border-[#e0e0e0]', 'hover:text-black');
          }
        });

        // Update sort label
        const activeSort = Array.from(sortBtns).find(b => b.getAttribute('data-sort-val') === currentSort);
        if (activeSort && sortLabel) {
          sortLabel.textContent = `Urutkan: ${activeSort.textContent.trim()}`;
        }

        // Apply filters and sorting - normalize both sides (remove spaces/hyphens)
        const normalize = (s) => s.toLowerCase().replace(/[\s\-]+/g, '');
        const visibleCards = cards.filter(card => {
          const cardCategory = (card.querySelector('.portfolio-item')?.getAttribute('data-category') || '');
          return currentCategory === 'semua' || normalize(cardCategory) === normalize(currentCategory);
        });

        // Sort visible cards
        visibleCards.sort((a, b) => {
          const dateA = new Date(a.querySelector('.portfolio-item').getAttribute('data-date')).getTime();
          const dateB = new Date(b.querySelector('.portfolio-item').getAttribute('data-date')).getTime();
          return currentSort === 'latest' ? dateB - dateA : dateA - dateB;
        });

        // Animate out all cards
        cards.forEach(card => card.style.display = 'none');
        showFiltered();

        function showFiltered() {
          const emptyState = document.getElementById('empty-state');
          const paginationDots = document.getElementById('pagination-dots');
          const loadMoreContainer = document.getElementById('load-more-container');
          const countNumber = document.getElementById('count-number');

          // Update results count
          if (countNumber) {
            countNumber.textContent = visibleCards.length.toString();
          }

          // Show/hide empty state based on visible cards
          if (visibleCards.length === 0) {
            emptyState?.classList.remove('hidden');
            grid?.classList.add('hidden');
            paginationDots?.classList.add('hidden');
            loadMoreContainer?.classList.add('hidden');
          } else {
            emptyState?.classList.add('hidden');
            grid?.classList.remove('hidden');

            // Show pagination and load more only if more than 9 projects
            if (visibleCards.length > 9) {
              paginationDots?.classList.remove('hidden');
              loadMoreContainer?.classList.remove('hidden');
            } else {
              paginationDots?.classList.add('hidden');
              loadMoreContainer?.classList.add('hidden');
            }

            visibleCards.forEach(card => {
              card.style.display = 'block';
              card.style.opacity = '1';
              card.style.transform = 'none';
              grid.appendChild(card); // Re-append in sorted order
            });
          }
        }

        // Update URL without reload
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('category', currentCategory);
        newUrl.searchParams.set('sort', currentSort);
        window.history.replaceState({}, '', newUrl);
      }

      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const newCategory = btn.getAttribute('data-category-filter');
          if (currentCategory === newCategory) return;
          currentCategory = newCategory;

          // Update category dropdown label if dropdown exists
          if (categoryLabel) {
            categoryLabel.textContent = btn.textContent.trim();
          }

          // Close category dropdown if open
          if (isCategoryOpen) {
            isCategoryOpen = false;
            toggleCategoryMenu(false);
          }

          updateUI();
        });
      });

      sortBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          if (currentSort === btn.getAttribute('data-sort-val')) return;
          currentSort = btn.getAttribute('data-sort-val');
          updateUI();
        });
      });

      // Dynamic Sync logic
      const syncWithStrapi = async () => {
        try {
          const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL || 'https://cms.sjdinterior.com';
          const response = await fetch(`${STRAPI_URL}/api/projects?pagination[limit]=24&populate=*`);
          if (!response.ok) return;
          const { data } = await response.json();
          
          const liveSlugs = data.map((item: any) => item.attributes.slug);
          
          let hasChanges = false;
          cards.forEach(card => {
            const cardEl = card as HTMLElement;
            const slug = cardEl.dataset.slug;
            
            if (slug && !liveSlugs.includes(slug)) {
              // Project was deleted or unpublished
              cardEl.remove();
              hasChanges = true;
            } else if (slug) {
              // Project exists, check if title changed
              const liveData = data.find((item: any) => item.attributes.slug === slug);
              if (liveData) {
                const attrs = liveData.attributes;
                const liveTitle = attrs.title;
                const liveCategoryLabel = attrs.category?.data?.attributes?.label || 'Uncategorized';
                const liveCategorySlug = attrs.category?.data?.attributes?.slug || 'uncategorized';

                const titleEl = cardEl.querySelector('h3');
                if (titleEl && titleEl.textContent !== liveTitle) {
                  titleEl.textContent = liveTitle;
                  hasChanges = true;
                }

                // Sync Category
                const itemEl = cardEl.querySelector('.portfolio-item');
                if (itemEl) {
                  const currentCategorySlug = itemEl.getAttribute('data-category');
                  if (currentCategorySlug !== liveCategorySlug) {
                    itemEl.setAttribute('data-category', liveCategorySlug);
                    hasChanges = true;
                  }

                  const categorySpan = itemEl.querySelector('span'); // The category badge
                  if (categorySpan && categorySpan.textContent?.trim() !== liveCategoryLabel) {
                    categorySpan.textContent = liveCategoryLabel;
                    hasChanges = true;
                  }
                }
              }
            }
          });

          if (hasChanges) {
            updateUI();
          }
        } catch (e) {
          console.warn('Sync failed:', e);
        }
      };

      // Initial run
      updateUI(true);
      
      // Trigger sync after a short delay
      setTimeout(syncWithStrapi, 1000);
    }

    // Run on load and on Astro swap (if using View Transitions)
    initPortfolioFilters();
    document.addEventListener('astro:after-swap', initPortfolioFilters);
  </script>

  <style>
    /* Hide scrollbar but keep functionality */
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    /* Smooth transitions for filter buttons */
    .filter-btn {
      transition: all 0.2s ease;
    }
  </style>
</BaseLayout>
