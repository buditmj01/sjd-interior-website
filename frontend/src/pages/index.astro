---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/common/Header.astro';
import Footer from '../components/common/Footer.astro';
import CTASection from '../components/common/CTASection.astro';
import InsightCard from '../components/common/InsightCard.astro';
import PortfolioCard from '../components/common/PortfolioCard.astro';
import Stats from '../components/home/Stats.astro';
import Hero from '../components/home/Hero.astro';
import { getInsights, getImageUrl } from '../lib/strapi';
import { getProjects } from '../lib/getProjects';
import { getStrapiMedia } from '../lib/strapi';

// Format date to Indonesian (same as insight page)
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('id-ID', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
};

// Fetch latest insights from Strapi (limit 4 for homepage)
const insightsResponse = await getInsights({ 'pagination[limit]': 4 });

// Transform insights data using the same approach as insight page
const insights = insightsResponse?.data?.map((insight: any) => ({
  title: insight.attributes.title,
  author: insight.attributes.author?.data?.attributes?.name || 'SJD Interior Team',
  authorPhoto: getImageUrl(insight.attributes.author?.data?.attributes?.photo, 'thumbnail'),
  date: formatDate(insight.attributes.publishedAt || insight.attributes.createdAt),
  category: insight.attributes.category.toUpperCase(),
  image: getImageUrl(insight.attributes.featured_image, 'medium') || '/images/insight-card.jpg',
  slug: insight.attributes.slug,
  featured: insight.attributes.is_featured || false
})) || [];

// Fetch latest portfolio projects from Strapi (limit 4 for homepage)
const projectsData = await getProjects({ limit: 4, sort: 'publishedAt:desc' });

// Transform projects data for the component
const portfolios = projectsData?.map((project: any) => {
  const attrs = project.attributes;
  const featuredImage = attrs.featured_image?.data ? getStrapiMedia(attrs.featured_image.data.attributes.url) : '/images/portfolio-main.png';

  return {
    title: attrs.title,
    category: attrs.category?.toUpperCase() || 'PROJECT',
    location: attrs.location || '',
    area: attrs.area_size || '',
    style: attrs.theme || '',
    image: featuredImage,
    slug: attrs.slug
  };
}) || [];

// Features data
const features = [
  { icon: "/icons/chat.svg", title: "Konsultasi" },
  { icon: "/icons/3d-modeling.svg", title: "Gambar 3D Modelling" },
  { icon: "/icons/quality-control.svg", title: "Quality Control" },
  { icon: "/icons/budget.svg", title: "Rencana Anggaran Biaya" },
  { icon: "/icons/technical-drawing.svg", title: "Gambar Teknis Arsitektur" },
  { icon: "/icons/warranty.svg", title: "Garansi" }
];

// Process steps
const processSteps = [
  { number: "01", title: "Konsultasi", description: "Ceritakan kebutuhan dan gaya yang Anda inginkan. Kami dengarkan, kami pahami.", image: "/images/workflow-consult.jpg" },
  { number: "02", title: "Desain & RAB", description: "Tim kami membuat konsep dan visualisasi 3D. Revisi sampai 3x.", image: "/images/workflow-design.png" },
  { number: "03", title: "Produksi", description: "Kami produksi furniture dan siapkan material. Anda tinggal menunggu.", image: "/images/process-production.png" },
  { number: "04", title: "Serah terima", description: "Instalasi selesai, quality check done. Interior impian Anda siap dinikmati.", image: "/images/process-handover.jpg" }
];

// Testimonials from Google Maps Reviews
const testimonials = [
  { name: "Trisna A.K", text: "Kualitas premium, pengerjaan cepat, fast respon, harga bisa bisik-bisik, ownernya bisa maen drum. Pokonya mantullll bintang 5", rating: 5 },
  { name: "Cahyani Linda", text: "Hasil bagus memuaskan, team ramah, desingnya bagus pokoknya memuaskan deh", rating: 5 },
  { name: "Neneng Susanti", text: "Hasilnya sesuai dengan keinginan, kwalitas bahannya juga ok, ga nyesel udah pake jasa desain interior nya, recommended banget", rating: 5 },
  { name: "Didik Hermansyah", text: "Recomended Aman, terpercaya.", rating: 5 },
  { name: "Naufal Taufikurrachman", text: "Lemari nya ok, bahan nya juga bagus, kuat kokoh. Pokok nya recommended üëç", rating: 5 },
  { name: "Oonye Cafe Bogor", text: "Terpercaya", rating: 5 },
  { name: "Lukman Nurhakim", text: "Terbaik, ramah dalam konsultasi", rating: 5 },
  { name: "Nabila Stwn", text: "Bikin lemari disini worth it banget, pelayanannya ramah, team nya satset. disini juga ada garansi nya, aftersales oke. secara bahan, harga semua nya transparant", rating: 5 },
  { name: "Rexia Rex", text: "Top markotop pokoknya", rating: 5 },
  { name: "Ardi Ardi Ansyah", text: "Hasil nya rapih & bagus üëçüëçüëç", rating: 5 },
  { name: "Look-Man", text: "Owner nya ramah, hasilnya bagus. Terimakasih SJD", rating: 5 },
  { name: "Nurma Yani", text: "Sangat memuaskan!", rating: 5 },
  { name: "Mustika Jaya", text: "Pengerjaan rapi, harga ok, dan pelayanan after sales servicenya baik üôå", rating: 5 },
  { name: "Jojo Handayani", text: "Terbaik, rekomen yang mau cari custom interior coba kesini deh bagus hasilnya memuaskan üëåüëç", rating: 5 },
  { name: "Moch Rizal", text: "Sangat recommended üëç", rating: 5 },
  { name: "Siti Hasanah", text: "Sangat di rekomendasikan bagi yang ingin membuat kitchenset, owner nya baikk sekali.", rating: 5 }
];
---

<BaseLayout>
  <Header />

  <main class="bg-white">
    <!-- Hero Section - Dynamic from Strapi -->
    <Hero />

    <!-- Introduction Section -->
    <section class="py-12 md:py-16 lg:py-20 bg-gradient-to-b from-white via-[#fff7ee] to-[#fff7ee]">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px]">
        <!-- Title - Left aligned -->
        <div class="mb-10 md:mb-14 lg:mb-16">
          <h2 class="text-left" data-animate-title>
            <span class="block text-[40px] md:text-[64px] lg:text-[96px] font-light text-black leading-[1.05]" style="letter-spacing: -2px;">SJD Interior adalah</span>
            <span class="block text-[40px] md:text-[64px] lg:text-[96px] font-light text-black leading-[1.05]" style="letter-spacing: -2px;">solusi desain lengkap</span>
            <span class="block text-[40px] md:text-[64px] lg:text-[96px] font-light text-black leading-[1.05]" style="letter-spacing: -2px;">personal dan tanpa</span>
            <span class="block text-[40px] md:text-[64px] lg:text-[96px] font-light text-black leading-[1.05]" style="letter-spacing: -2px;">ribet.</span>
          </h2>

          <!-- Subtitle - Left aligned with proper spacing -->
          <p class="text-[18px] md:text-[26px] lg:text-[36px] font-light text-black mt-6 md:mt-7 lg:mt-8 leading-[1.3]" style="letter-spacing: -0.9px;" data-animate-subtitle>
            Kami handle semuanya, dari desain hingga furniture.<br />
            Tersedia sekarang di Jabodetabek.
          </p>
        </div>

        <!-- Portfolio Grid - Responsive columns -->
        <!-- Mobile: 2x2 Grid | Desktop: 4 Columns -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-5 mb-6 md:mb-8">
          {portfolios.map((item) => (
            <div class="w-full">
              <PortfolioCard {...item} />
            </div>
          ))}
        </div>

        <!-- CTA Link - Below portfolio cards -->
        <a href="/portfolio" class="inline-flex items-center gap-2 text-[16px] md:text-[18px] lg:text-[20px] font-light text-black hover:gap-4 transition-all duration-300 group">
          Mau lihat hasil kerja kami? Jelajahi portfolio
          <svg class="w-4 h-4 md:w-5 md:h-5 transition-transform duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
          </svg>
        </a>
      </div>
    </section>

    <!-- Stats Section -->
    <Stats />

    <!-- Features Section -->
    <section class="py-12 md:py-20 lg:py-24 bg-gradient-to-b from-[#fff7ee] to-white">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px]">
        <h2 class="text-[36px] md:text-[52px] lg:text-[70px] font-light text-black text-center mb-10 md:mb-16 lg:mb-20" style="letter-spacing: -1.8px;" data-animate-title>
          Fasilitas yang anda dapatkan.
        </h2>

        <!-- Mobile: 2x3 Grid (fits in one view) | Desktop: 3 Columns -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-8 md:gap-x-12 lg:gap-x-16 md:gap-y-12 lg:gap-y-16">
          {features.map((feature) => (
            <div class="group flex flex-col items-center text-center">
              <!-- Icon Container -->
              <div class="w-[56px] h-[56px] md:w-[72px] md:h-[72px] mb-3 md:mb-5 flex items-center justify-center rounded-2xl bg-[#f5f5f5] transition-all duration-300 group-hover:bg-[#0096f7]/10 group-hover:scale-110">
                <img
                  src={feature.icon}
                  alt={feature.title}
                  class="w-7 h-7 md:w-10 md:h-10 object-contain opacity-70 transition-all duration-300 group-hover:opacity-100"
                />
              </div>
              <!-- Title -->
              <h3 class="text-[15px] md:text-[19px] lg:text-[20px] font-normal text-[#313131] leading-tight transition-colors duration-300 group-hover:text-[#0096f7] max-w-[140px] md:max-w-none mx-auto">
                {feature.title}
              </h3>
            </div>
          ))}
        </div>
      </div>
    </section>

    <!-- Testimonials Section -->
    <section class="py-16 md:py-20 lg:py-24 bg-white overflow-hidden">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px] mb-10 md:mb-14 lg:mb-16">
        <h2 class="text-[36px] md:text-[52px] lg:text-[70px] font-light text-black text-center" style="letter-spacing: -1.8px;" data-animate-title>
          Apa kata mereka tentang SJD Interior
        </h2>
      </div>

      <!-- Testimonials Carousel with Fade -->
      <div class="relative">
        <!-- Left Fade -->
        <div class="absolute left-0 top-0 bottom-0 w-[50px] md:w-[100px] lg:w-[150px] bg-gradient-to-r from-white to-transparent z-10 pointer-events-none"></div>
        <!-- Right Fade -->
        <div class="absolute right-0 top-0 bottom-0 w-[50px] md:w-[100px] lg:w-[150px] bg-gradient-to-l from-white to-transparent z-10 pointer-events-none"></div>

        <!-- Infinite Scroll Track -->
        <div class="flex testimonial-scroll">
          <div class="flex gap-4 md:gap-6 animate-scroll">
            {[...testimonials, ...testimonials].map((testimonial) => (
              <div class="flex-shrink-0 w-[300px] md:w-[360px] lg:w-[400px] min-h-[240px] md:h-[260px] bg-[#fafafa] border border-[#e8e8e8] rounded-[20px] p-6 md:p-8 flex flex-col transition-all duration-300 hover:shadow-lg hover:border-[#d0d0d0]">
                <!-- Star Rating -->
                <div class="flex gap-1 mb-3 md:mb-4">
                  {[...Array(5)].map((_, i) => (
                    <svg class={`w-3.5 h-3.5 md:w-4 md:h-4 ${i < testimonial.rating ? 'text-[#FFB800]' : 'text-[#E0E0E0]'}`} fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                  ))}
                </div>

                <!-- Review Text - Italic -->
                <p class="text-[14px] md:text-[15px] lg:text-[16px] font-light text-[#444444] leading-relaxed italic flex-1">
                  "{testimonial.text}"
                </p>

                <!-- Bottom Section - Always at bottom -->
                <div class="mt-auto pt-3 md:pt-4">
                  <!-- Divider -->
                  <div class="w-8 h-[1px] bg-[#e0e0e0] mb-2 md:mb-3"></div>
                  <!-- Name -->
                  <p class="text-[14px] md:text-[15px] font-medium text-black">{testimonial.name}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </section>

    <!-- Process Steps Section -->
    <section class="py-12 md:py-16 lg:py-20 bg-white">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px]">
        <!-- Title -->
        <div class="text-center mb-10 md:mb-14 lg:mb-16 px-4 md:px-0">
          <h2 class="text-[36px] md:text-[88px] lg:text-[128px] font-light text-black mb-4 md:mb-6 lg:mb-8 leading-[1.1] md:leading-[0.99]" style="letter-spacing: -1.8px;" data-animate-title>
            Dapatkan interior impian dalam empat langkah.
          </h2>
          <p class="text-[18px] md:text-[36px] lg:text-[48px] font-light text-[#929292] leading-[1.3]" style="letter-spacing: -0.8px;" data-animate-subtitle>
            Secepat 2-8 minggu pengerjaan.
          </p>
        </div>

        <!-- Steps Grid -->
        <div class="relative">
          <!-- Horizontal connecting line - only on desktop -->
          <div class="hidden lg:block absolute top-[26px] left-[calc(12.5%-10px)] right-[calc(12.5%-10px)] h-[1px] bg-[#d4d4d4] z-0"></div>


          
          <div class="relative z-10 flex md:grid md:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-5 mb-10 md:mb-14 lg:mb-16 overflow-x-auto snap-x snap-mandatory scrollbar-hide -mx-6 px-6 md:mx-0 md:px-0 pb-4 md:pb-0">
            {processSteps.map((step, index) => (
              <div class="text-center flex flex-col min-w-[85vw] md:min-w-0 snap-center px-2">
                <!-- Number with rounded shape - 1&3 filled, 2&4 outline -->
                <div class="flex justify-center mb-5 md:mb-4">
                  <div class={`w-[56px] h-[56px] md:w-[52px] md:h-[52px] rounded-[14px] md:rounded-[14px] flex items-center justify-center ${index === 0 || index === 2 ? 'bg-black' : 'bg-white border border-[#c4c4c4]'}`}>
                    <span class={`text-[20px] md:text-[18px] font-medium ${index === 0 || index === 2 ? 'text-white' : 'text-[#c4c4c4]'}`} style="letter-spacing: -0.8px;">
                      {step.number}
                    </span>
                  </div>
                </div>
                <!-- Title -->
                <h3 class="text-[32px] md:text-[28px] lg:text-[32px] font-light text-black mb-5 md:mb-4 px-2" style="letter-spacing: -1.2px;">
                  {step.title}
                </h3>
                <!-- Description -->
                <p class="text-[17px] md:text-[16px] lg:text-[18px] font-normal text-[#929292] leading-[1.6] mb-8 md:mb-6 px-4" style="letter-spacing: -0.4px;">
                  {step.description}
                </p>
                <!-- Image with smaller aspect ratio for mobile - text dominant -->
                <div class="relative overflow-hidden rounded-[20px] aspect-[5/4] md:aspect-[3/4] mt-auto">
                  <img
                    src={step.image}
                    alt={step.title}
                    class="w-full h-full object-cover"
                  />
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- CTA -->
        <!-- CTA -->
        <div class="text-center mt-8 md:mt-0">
          <p class="text-[24px] md:text-[36px] lg:text-[46.21px] font-light text-black mb-3 md:mb-2 leading-tight tracking-[-1px] md:tracking-[-1.4px]" data-animate-title>
            Mau tahu lebih detail?
          </p>
          <p class="text-[24px] md:text-[36px] lg:text-[46.21px] font-light text-[#666] md:text-[#919191] mb-10 md:mb-10 leading-tight tracking-[-1px] md:tracking-[-1.4px]" data-animate-subtitle>
            Pelajari proses kerja kami dari awal sampai akhir.
          </p>
          <div class="flex flex-col md:flex-row justify-center gap-4 md:gap-4 w-full md:w-auto">
            <a
              href="/alur-kerja"
              class="w-full md:w-auto inline-flex items-center justify-center px-8 md:px-10 py-4 md:py-4 text-[16px] md:text-[21.41px] font-medium text-[#1a1a1a] border border-[#e5e5e5] md:border-[#424242] rounded-full hover:bg-[#1a1a1a] hover:text-white hover:border-[#1a1a1a] transition-all duration-300"
            >
              Cara Kerja
            </a>
            <a
              href="https://wa.me/6285398989810?text=Halo%20SJD%20Interior%2C%20saya%20ingin%20berkonsultasi."
              target="_blank"
              rel="noopener noreferrer"
              class="w-full md:w-auto inline-flex items-center justify-center px-8 md:px-10 py-4 md:py-4 text-[16px] md:text-[21.41px] font-medium text-white bg-[#1a1a1a] rounded-full hover:bg-black hover:scale-105 active:scale-95 transition-all duration-300 shadow-lg md:shadow-none"
            >
              Konsultasi
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Insight Section -->
    <section class="py-12 md:py-16 lg:py-20 bg-white">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px]">
        <h2 class="text-[44px] md:text-[72px] lg:text-[103.13px] font-light text-black text-center mb-10 md:mb-14 lg:mb-16" style="letter-spacing: -2.2px;" data-animate-title>
          Insight untuk anda.
        </h2>

        <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-5 lg:gap-6 mb-8 md:mb-10 lg:mb-12">
          {insights.map((insight) => (
            <InsightCard {...insight} />
          ))}
        </div>

        <div class="text-center">
          <a
            href="/insight"
            class="inline-flex items-center justify-center px-10 py-4 text-[21.41px] font-medium text-[#424242] border-2 border-[#424242] rounded-full hover:bg-[#424242] hover:text-white transition-all duration-300"
          >
            Lihat Selengkapnya
          </a>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <CTASection />
  </main>

  <Footer />
</BaseLayout>

<style>
  /* Hide scrollbar but keep functionality */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Infinite scroll animation */
  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  .animate-scroll {
    animation: scroll 60s linear infinite;
  }

  .animate-scroll:hover {
    animation-play-state: paused;
  }
</style>

<!-- Section Title Animations -->
<script>
  import { createReveal, ScrollTrigger } from '../utils/gsap';

  const initTitleAnimations = () => {
    console.log('Initializing title animations...');

    // Animate all titles with data-animate-title
    const titles = document.querySelectorAll('[data-animate-title]');
    titles.forEach((title, index) => {
      createReveal(title as HTMLElement, {
        from: { opacity: 0, y: 60 },
        to: { opacity: 1, y: 0 },
        start: 'top 80%',
        once: true,
      });
    });

    // Animate all subtitles with data-animate-subtitle
    const subtitles = document.querySelectorAll('[data-animate-subtitle]');
    subtitles.forEach((subtitle, index) => {
      createReveal(subtitle as HTMLElement, {
        from: { opacity: 0, y: 60 },
        to: { opacity: 1, y: 0 },
        delay: 0.2,
        start: 'top 80%',
        once: true,
      });
    });
  };

  // Initialize after a short delay to ensure GSAP is ready
  const initWithDelay = () => {
    setTimeout(() => {
      initTitleAnimations();
      // Refresh ScrollTrigger to ensure proper calculation
      ScrollTrigger.refresh();
    }, 100);
  };

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWithDelay);
  } else {
    // DOM already loaded
    initWithDelay();
  }

  // Re-initialize for Astro view transitions
  document.addEventListener('astro:page-load', () => {
    // Kill existing triggers first
    ScrollTrigger.getAll().forEach(trigger => {
      const triggerElement = trigger.vars.trigger as HTMLElement;
      if (triggerElement && (
        triggerElement.hasAttribute('data-animate-title') ||
        triggerElement.hasAttribute('data-animate-subtitle')
      )) {
        trigger.kill();
      }
    });
    initWithDelay();
  });
</script>
