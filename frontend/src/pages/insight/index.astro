---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/common/Header.astro';
import Footer from '../../components/common/Footer.astro';
import CTASection from '../../components/common/CTASection.astro';
import InsightCard from '../../components/common/InsightCard.astro';
import { getInsights, getImageUrl } from '../../lib/strapi';

// Format date to Indonesian
const formatDate = (dateString) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('id-ID', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
};

// Fetch insights from Strapi
let allArticles = [];

try {
  const response = await getInsights({ 'pagination[limit]': 12 });
  allArticles = response.data?.map((insight) => ({
    title: insight.attributes.title,
    author: insight.attributes.author?.data?.attributes?.name || 'SJD Interior Team',
    authorPhoto: getImageUrl(insight.attributes.author?.data?.attributes?.photo, 'thumbnail'),
    date: formatDate(insight.attributes.publishedAt || insight.attributes.createdAt),
    category: insight.attributes.category.toUpperCase(),
    image: getImageUrl(insight.attributes.featured_image, 'medium') || '/images/insight-card.jpg',
    slug: insight.attributes.slug,
    featured: insight.attributes.is_featured || false
  })) || [];

} catch (error) {
  console.error('Error fetching insights:', error);
  // Fallback to mock data if Strapi fails
  allArticles = Array(9).fill(null).map((_, i) => ({
    title: `Artikel Desain Interior ${i + 1}`,
    author: "SJD Interior Team",
    date: "1 Januari 2026",
    category: "TIPS",
    image: "/images/insight-card.jpg",
    slug: `artikel-${i + 1}`,
    featured: i === 0
  }));
}
---

<BaseLayout
  title="Insight - SJD Interior"
  description="Artikel dan tips seputar desain interior dari SJD Interior"
>
  <Header />

  <main class="bg-white">
    <!-- Hero Section - Compact & Focused -->
    <section class="relative pt-52 md:pt-36 lg:pt-44 pb-20 md:pb-12 lg:pb-16 bg-white">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px] text-center md:text-left">
        <h1 class="text-[72px] md:text-[96px] lg:text-[128px] font-light text-black mb-4 md:mb-4 lg:mb-6 leading-[0.95]" style="letter-spacing: -2.8px;">
          Insight
        </h1>
        <p class="text-[24px] md:text-[28px] lg:text-[36px] font-light text-[#666] leading-[1.3] max-w-3xl mx-auto md:mx-0" style="letter-spacing: -0.5px;">
          Tips, tren, dan inspirasi desain interior
        </p>
      </div>
    </section>

    <!-- Search & Filter Section - Sticky -->
    <section class="sticky top-[60px] md:top-[80px] z-40 pt-16 md:pt-16 pb-5 md:pb-6 bg-white border-b border-[#e5e5e5] backdrop-blur-sm bg-white/95">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px]">

        <!-- Search Bar - Full Width -->
        <div class="mb-4">
          <div class="relative max-w-2xl">
            <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[#999]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="M21 21l-4.35-4.35"/>
            </svg>
            <input
              type="search"
              placeholder="Cari artikel..."
              id="search-input"
              class="w-full pl-12 pr-4 py-3 text-[15px] text-[#333] bg-[#fafafa] border border-[#e5e5e5] rounded-full focus:outline-none focus:border-[#000] focus:bg-white transition-all placeholder:text-[#999]"
            />
          </div>
        </div>

        <!-- Filters & Controls Row -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-4">

          <!-- Left: Category Filters -->
          <div class="flex gap-2 overflow-x-auto scrollbar-hide -mx-6 px-6 md:mx-0 md:px-0" id="category-filters">
            <button class="filter-btn active px-4 py-2 bg-black text-white text-[13px] md:text-[14px] font-medium rounded-full hover:bg-[#333] transition-all whitespace-nowrap" data-category="ALL">
              Semua
            </button>
            <button class="filter-btn px-4 py-2 bg-white text-[#666] text-[13px] md:text-[14px] font-medium border border-[#e5e5e5] rounded-full hover:border-black hover:text-black transition-all whitespace-nowrap" data-category="TIPS">
              Tips
            </button>
            <button class="filter-btn px-4 py-2 bg-white text-[#666] text-[13px] md:text-[14px] font-medium border border-[#e5e5e5] rounded-full hover:border-black hover:text-black transition-all whitespace-nowrap" data-category="TREND">
              Trend
            </button>
            <button class="filter-btn px-4 py-2 bg-white text-[#666] text-[13px] md:text-[14px] font-medium border border-[#e5e5e5] rounded-full hover:border-black hover:text-black transition-all whitespace-nowrap" data-category="NEWS">
              News
            </button>
            <button class="filter-btn px-4 py-2 bg-white text-[#666] text-[13px] md:text-[14px] font-medium border border-[#e5e5e5] rounded-full hover:border-black hover:text-black transition-all whitespace-nowrap" data-category="TUTORIAL">
              Tutorial
            </button>
          </div>

          <!-- Right: Sort & Results Count -->
          <div class="flex items-center gap-4 md:gap-6 px-6 md:px-0 -mx-6 md:mx-0">
            <!-- Sort Dropdown -->
            <div class="flex items-center gap-2">
              <label for="sort-select" class="text-[13px] md:text-[14px] font-medium text-[#666] whitespace-nowrap">Urutkan:</label>
              <div class="relative">
                <select id="sort-select" class="appearance-none pl-3 pr-8 py-1.5 bg-white border border-[#e5e5e5] rounded-full text-[13px] md:text-[14px] font-medium text-black focus:outline-none focus:border-black cursor-pointer transition-all hover:border-[#999]">
                  <option value="latest">Terbaru</option>
                  <option value="oldest">Terlama</option>
                </select>
                <svg class="absolute right-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-black pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>

            <!-- Divider -->
            <div class="w-px h-4 bg-[#e5e5e5]"></div>

            <!-- Results Count -->
            <p class="text-[13px] md:text-[14px] text-[#666] whitespace-nowrap" id="results-count">
              <span class="font-medium text-black" id="count-number">{allArticles.length}</span> artikel
            </p>
          </div>
        </div>

      </div>
    </section>

    <!-- Articles Grid -->
    <section class="py-8 md:py-12 lg:py-16 bg-white">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px]">

        <!-- Articles Grid -->
        <div id="articles-grid" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 mb-8 md:mb-12">
          {allArticles.map((article) => (
            <div class="article-item" data-category={article.category} data-date={new Date(article.date).getTime()} data-title={article.title.toLowerCase()}>
              <InsightCard {...article} />
            </div>
          ))}
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16 md:py-24">
          <svg class="w-16 h-16 md:w-20 md:h-20 mx-auto mb-4 text-[#ddd]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h3 class="text-xl md:text-2xl font-light text-[#666] mb-2">Tidak ada artikel ditemukan</h3>
          <p class="text-[14px] md:text-[15px] text-[#999]">Coba ubah filter atau kata kunci pencarian</p>
        </div>

        <!-- Load More Button -->
        <div class="text-center hidden" id="load-more-container">
          <button class="inline-flex items-center gap-2 px-8 md:px-10 py-3 md:py-3.5 text-[15px] md:text-[16px] font-medium text-black border-2 border-black rounded-full hover:bg-black hover:text-white transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
            <span>Muat Lebih Banyak</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <CTASection />
  </main>

  <Footer />
</BaseLayout>

<style>
  /* Hide scrollbar but keep functionality */
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Smooth transitions for filter buttons */
  .filter-btn {
    transition: all 0.2s ease;
  }

  /* Search input focus effect */
  #search-input:focus {
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const grid = document.getElementById('articles-grid');
    const articles = Array.from(document.querySelectorAll('.article-item'));
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
    const filterBtns = document.querySelectorAll('.filter-btn');
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const emptyState = document.getElementById('empty-state');
    const countNumber = document.getElementById('count-number');

    let currentCategory = 'ALL';
    let currentSort = 'latest';
    let searchQuery = '';

    // Update results count
    const updateResultsCount = () => {
      const visibleArticles = articles.filter(article =>
        (article as HTMLElement).style.display !== 'none'
      );
      const count = visibleArticles.length;
      const loadMoreContainer = document.getElementById('load-more-container');

      if (countNumber) {
        countNumber.textContent = count.toString();
      }

      // Show/hide empty state
      if (emptyState) {
        if (count === 0) {
          emptyState.classList.remove('hidden');
          grid?.classList.add('hidden');
        } else {
          emptyState.classList.add('hidden');
          grid?.classList.remove('hidden');
        }
      }

      // Show/hide load more button (only show if more than 9 articles)
      if (loadMoreContainer) {
        if (count > 9) {
          loadMoreContainer.classList.remove('hidden');
        } else {
          loadMoreContainer.classList.add('hidden');
        }
      }
    };

    // Sort Function
    const sortArticles = () => {
      const sortedArticles = articles.sort((a, b) => {
        const dateA = parseInt((a as HTMLElement).dataset.date || '0');
        const dateB = parseInt((b as HTMLElement).dataset.date || '0');

        return currentSort === 'latest' ? dateB - dateA : dateA - dateB;
      });

      // Re-append sorted articles
      sortedArticles.forEach(article => grid?.appendChild(article));
    };

    // Filter Function
    const filterArticles = () => {
      articles.forEach(article => {
        const articleEl = article as HTMLElement;
        const category = articleEl.dataset.category || '';
        const title = articleEl.dataset.title || '';

        const matchesCategory = currentCategory === 'ALL' || category === currentCategory;
        const matchesSearch = title.includes(searchQuery.toLowerCase());

        if (matchesCategory && matchesSearch) {
          articleEl.style.display = 'block';
        } else {
          articleEl.style.display = 'none';
        }
      });

      updateResultsCount();
    };

    // Event Listeners
    sortSelect?.addEventListener('change', (e) => {
      currentSort = (e.target as HTMLSelectElement).value;
      sortArticles();
    });

    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active class
        filterBtns.forEach(b => {
          b.classList.remove('bg-black', 'text-white');
          b.classList.add('bg-white', 'text-[#666]', 'border', 'border-[#e5e5e5]');
        });
        btn.classList.remove('bg-white', 'text-[#666]', 'border', 'border-[#e5e5e5]');
        btn.classList.add('bg-black', 'text-white');

        currentCategory = (btn as HTMLElement).dataset.category || 'ALL';
        filterArticles();
      });
    });

    searchInput?.addEventListener('input', (e) => {
      searchQuery = (e.target as HTMLInputElement).value;
      filterArticles();
    });

    // Initial Sort
    sortArticles();
    updateResultsCount();
  });
</script>
