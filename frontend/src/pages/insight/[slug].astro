---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/common/Header.astro';
import Footer from '../../components/common/Footer.astro';
import CTASection from '../../components/common/CTASection.astro';
import InsightCard from '../../components/common/InsightCard.astro';
import { getInsights, getInsightBySlug } from '../../lib/getInsights';
import { getStrapiMedia } from '../../lib/strapi';

// Generate static paths for SSG
export async function getStaticPaths() {
  try {
    const insights = await getInsights({ limit: 100 });

    return (insights || []).map((insight: any) => ({
      params: { slug: insight.attributes.slug },
    }));
  } catch (error) {
    console.error('Error fetching insights for static paths:', error);
    return [];
  }
}

const { slug } = Astro.params;

import { marked } from 'marked';

// Fetch the insight from Strapi
let insight = null;
let article = null;
let relatedInsights = [];

try {
  insight = await getInsightBySlug(slug);

  if (insight) {
    // Format the article data
    const categoryMap = {
      'tips': 'TIPS',
      'trends': 'TRENDS',
      'inspiration': 'INSPIRATION',
      'how-to': 'HOW-TO',
      'case-study': 'CASE STUDY',
      'news': 'NEWS'
    };

    const formattedDate = new Date(insight.attributes.createdAt).toLocaleDateString('id-ID', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });

    const rawContent = insight.attributes.content || '';
    const parsedContent = await marked.parse(rawContent);

    // Get author information from relation
    const authorData = insight.attributes.author?.data;
    const authorPhoto = authorData?.attributes?.photo?.data ? getStrapiMedia(authorData.attributes.photo.data.attributes.url) : null;

    const author = authorData ? {
      name: authorData.attributes.name,
      job: authorData.attributes.job,
      bio: authorData.attributes.bio,
      photo: authorPhoto,
    } : {
      name: 'SJD Interior Team',
      job: 'Interior Design Team',
      bio: 'Tim profesional desainer interior yang berdedikasi untuk menciptakan ruang yang indah dan fungsional.',
      photo: null,
    };

    const mainImage = insight.attributes.featured_image?.data ? getStrapiMedia(insight.attributes.featured_image.data.attributes.url) : '/images/portfolio-main.png';
    const galleryImages = insight.attributes.gallery?.data ? insight.attributes.gallery.data.map((img: any) => getStrapiMedia(img.attributes.url)) : [];

    article = {
      title: insight.attributes.title,
      author: author,
      date: formattedDate,
      category: categoryMap[insight.attributes.category] || insight.attributes.category.toUpperCase(),
      excerpt: insight.attributes.excerpt,
      content: parsedContent,
      mainImage: mainImage,
      contentImages: galleryImages
    };

    // Fetch related insights (exclude current one by slug)
    const relatedInsightsData = await getInsights({
      limit: 3,
      excludeSlug: slug,
      sort: 'publishedAt:desc'
    });

    relatedInsights = (relatedInsightsData || []).map((item: any) => {
      const authorName = item.attributes.author?.data?.attributes?.name || 'SJD Interior Team';
      const publishedDate = item.attributes.publishedAt ? new Date(item.attributes.publishedAt).toLocaleDateString('id-ID', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      }) : '';
      const featuredImage = item.attributes.featured_image?.data ? getStrapiMedia(item.attributes.featured_image.data.attributes.url) : '/images/insight-card.jpg';

      return {
        title: item.attributes.title,
        author: authorName,
        date: publishedDate,
        category: categoryMap[item.attributes.category] || item.attributes.category.toUpperCase(),
        image: featuredImage,
        slug: item.attributes.slug
      };
    });
  }
} catch (error) {
  console.error('Error fetching insight:', error);
}

// If insight not found, return 404
if (!article) {
  return Astro.redirect('/404');
}
---

<BaseLayout
  title={`${article.title} - SJD Interior`}
  description={article.title}
>
  <Header />

  <main class="bg-white">
    <!-- Breadcrumb -->
    <section class="pt-32 md:pt-40 lg:pt-44 pb-4 md:pb-5 lg:pb-6">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[124px]">
        <p class="text-[12px] md:text-[13px] lg:text-[14px] font-medium tracking-wide">
          <a href="/" class="text-[#bcbcbc] hover:text-black transition-colors">Beranda</a>
          <span class="text-[#bcbcbc] mx-1.5 md:mx-2">&gt;</span>
          <a href="/insight" class="text-[#bcbcbc] hover:text-black transition-colors">Insight</a>
          <span class="text-[#bcbcbc] mx-1.5 md:mx-2">&gt;</span>
          <span class="text-black line-clamp-1 inline-flex align-bottom"> {article.title}</span>
        </p>
      </div>
    </section>

    <!-- Article Header & Featured Image -->
    <section class="pb-10 md:pb-11 lg:pb-12">
      <div class="w-full max-w-[1000px] mx-auto px-6 text-center mb-8 md:mb-10 lg:mb-12">
        <!-- Category & Date -->
        <div class="flex items-center justify-center gap-3 md:gap-4 mb-5 md:mb-6">
          <span class="px-3 md:px-4 py-1 md:py-1.5 bg-black text-white text-[11px] md:text-[12px] font-medium rounded-full tracking-wider">
            {article.category}
          </span>
          <span class="text-[13px] md:text-[14px] text-[#757575] font-medium">
            {article.date}
          </span>
        </div>

        <!-- Title -->
        <h1 class="text-[32px] md:text-[48px] lg:text-[64px] font-normal text-black mb-8 leading-[1.15] tracking-tight">
          {article.title}
        </h1>

        <!-- Author (Removed from here) -->

      </div>

      <!-- Featured Image -->
      <div class="w-full max-w-[1240px] mx-auto px-6 md:px-8 lg:px-0">
        <div class="relative w-full aspect-[16/9] md:aspect-[21/9] overflow-hidden rounded-lg md:rounded-none">
          <img
            src={article.mainImage}
            alt={article.title}
            class="absolute inset-0 w-full h-full object-cover"
          />
        </div>
      </div>
    </section>

    <!-- Article Content -->
    <section class="pb-14 md:pb-16 lg:pb-20">
      <div class="w-full max-w-[720px] mx-auto px-6">
        <!-- Excerpt if available -->
        {article.excerpt && (
          <p class="text-[17px] md:text-[19px] lg:text-[20px] text-[#292929] leading-[1.6] mb-6 md:mb-7 lg:mb-8 font-light italic border-l-[3px] md:border-l-4 border-black pl-4 md:pl-6">
            {article.excerpt}
          </p>
        )}

        <!-- Main Content from Strapi -->
        <div class="prose prose-sm md:prose-lg prose-p:text-[16px] md:prose-p:text-[18px] prose-p:leading-[1.8] prose-p:text-[#333] prose-headings:font-normal prose-headings:text-black prose-h2:text-[24px] md:prose-h2:text-[28px] lg:prose-h2:text-[32px] prose-h2:mb-4 md:prose-h2:mb-6 prose-h2:mt-8 md:prose-h2:mt-10 lg:prose-h2:mt-12 prose-h2:tracking-tight prose-h3:text-[20px] md:prose-h3:text-[22px] lg:prose-h3:text-[24px] prose-h3:mb-3 md:prose-h3:mb-4 prose-h3:mt-6 md:prose-h3:mt-7 lg:prose-h3:mt-8 prose-h3:tracking-tight prose-ul:space-y-2 md:prose-ul:space-y-3 prose-ol:space-y-2 md:prose-ol:space-y-3 prose-li:text-[16px] md:prose-li:text-[18px] prose-li:text-[#333] prose-strong:text-black prose-strong:font-bold prose-a:text-black prose-a:underline hover:prose-a:text-[#0096f7] prose-img:rounded-xl md:prose-img:rounded-2xl max-w-none">
          <Fragment set:html={article.content} />
        </div>

        <!-- Inline Images Grid -->
        {article.contentImages && article.contentImages.length > 0 && (
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 my-8 md:my-10 lg:my-12 -mx-0 md:-mx-12">
            {article.contentImages.map((img) => (
              <div class="relative aspect-[4/3] rounded-lg md:rounded-xl overflow-hidden">
                <img src={img} alt="Gallery" class="absolute inset-0 w-full h-full object-cover hover:scale-105 transition-transform duration-500" />
              </div>
            ))}
          </div>
        )}

        <!-- Author Bio Section -->
        <div class="mt-12 md:mt-14 lg:mt-16 pt-6 md:pt-7 lg:pt-8 border-t border-[#eee]">
            <div class="flex flex-col sm:flex-row items-center sm:items-start gap-4 md:gap-5 lg:gap-6 text-center sm:text-left">
                <div class="flex-shrink-0 w-16 h-16 md:w-20 md:h-20 rounded-full bg-gray-200 overflow-hidden">
                    {article.author.photo ? (
                      <img src={article.author.photo} alt={article.author.name} class="w-full h-full object-cover" />
                    ) : (
                      <svg class="w-full h-full text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
                      </svg>
                    )}
                </div>
                <div>
                    <p class="text-[11px] md:text-[12px] font-bold text-[#999] uppercase tracking-wider mb-1">Tentang Penulis</p>
                    <h3 class="text-[18px] md:text-[20px] font-bold text-black mb-1.5 md:mb-2">{article.author.name}</h3>
                    <p class="text-[13px] md:text-[14px] text-[#888] mb-1.5 md:mb-2">{article.author.job}</p>
                    <p class="text-[14px] md:text-[15px] lg:text-[16px] text-[#666] leading-relaxed">
                        {article.author.bio}
                    </p>
                </div>
            </div>
        </div>
      </div>
    </section>

    <!-- Related Articles -->
    <section class="py-14 md:py-16 lg:py-20 bg-[#f9f9f9] border-t border-[#eee]">
      <div class="w-full max-w-[1761px] mx-auto px-6 md:px-12 lg:px-[151px]">
        <div class="flex items-center justify-between mb-8 md:mb-10 lg:mb-12">
          <h2 class="text-[26px] md:text-[36px] lg:text-[42px] font-light text-black leading-tight tracking-tight">
            Artikel Lainnya
          </h2>
          <a href="/insight" class="hidden md:inline-flex items-center justify-center px-6 md:px-8 py-2.5 md:py-3 text-[14px] md:text-[15px] font-medium text-black border border-black rounded-full hover:bg-black hover:text-white transition-all duration-300">
            Lihat Semua
          </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 md:gap-6 lg:gap-8">
          {relatedInsights.map((insight) => (
            <InsightCard {...insight} />
          ))}
        </div>

        <div class="md:hidden mt-6 md:mt-8 text-center">
            <a href="/insight" class="inline-flex items-center justify-center px-6 md:px-8 py-2.5 md:py-3 text-[14px] md:text-[15px] font-medium text-black border border-black rounded-full hover:bg-black hover:text-white transition-all duration-300">
            Lihat Semua
          </a>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <CTASection />
  </main>

  <Footer />
</BaseLayout>
