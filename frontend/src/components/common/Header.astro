---
import Button from './Button.astro';
import { getWebsiteLogos } from '../../lib/getWebsiteLogos.js';
import { getNavigation } from '../../lib/getNavigation.js';
import { getContactInfo } from '../../lib/getContactInfo';

// Fetch website logos
const logosData = await getWebsiteLogos();
const logos = logosData?.attributes?.websiteLogos || {};

// Fetch navigation from Strapi
const navigationData = await getNavigation();

// Default fallback navigation
const defaultNavItems = [
  { label: 'Beranda', url: '/' },
  { label: 'Alur Kerja', url: '/alur-kerja' },
  { label: 'Portofolio', url: '/portfolio' },
  { label: 'Insight', url: '/insight' },
  { label: 'Hubungi Kami', url: '/hubungi-kami' },
];

const defaultCta = {
  text: 'Konsultasi',
  type: 'whatsapp',
  pageUrl: '/hubungi-kami'
};

// Use Strapi data if available, otherwise use defaults
const navItems = navigationData?.attributes?.menuItems || defaultNavItems;
const ctaConfig = navigationData?.attributes ? {
  text: navigationData.attributes.cta_text || defaultCta.text,
  type: navigationData.attributes.cta_type || defaultCta.type,
  pageUrl: navigationData.attributes.cta_page_url || defaultCta.pageUrl
} : defaultCta;

// Fetch contact info for WhatsApp number
const contactData = await getContactInfo();
const whatsappNumber = contactData?.attributes?.whatsapp_number || '6285398989810';

// Build CTA URL based on type
const ctaUrl = ctaConfig.type === 'whatsapp'
  ? `https://wa.me/${whatsappNumber}?text=Halo%20SJD%20Interior%2C%20saya%20ingin%20berkonsultasi%20tentang%20proyek%20interior%20saya.`
  : ctaConfig.pageUrl;

const currentPath = Astro.url.pathname;
---

<header
  id="main-header"
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 bg-transparent text-white"
>
  <div class="w-full max-w-[1761px] mx-auto px-[42px]">
    <div class="flex items-center justify-between h-[110px]">
      <!-- Logo - matching Figma -->
      <a
        href="/"
        class="hover:opacity-80 transition-opacity header-logo-link relative"
      >
        {(logos.logo?.data || logos.logoLight?.data) ? (
          <>
            {/* Dark logo - shown on white/scrolled header */}
            {logos.logo?.data && (
              <img
                src={`${import.meta.env.PUBLIC_STRAPI_URL || 'http://localhost:1337'}${logos.logo.data.attributes.url}`}
                alt={logos.logo.data.attributes.alternativeText || 'Logo'}
                class="h-12 md:h-16 w-auto object-contain logo-dark absolute top-0 left-0"
                loading="eager"
              />
            )}
            {/* Light logo - shown on transparent/hero header */}
            {logos.logoLight?.data && (
              <img
                src={`${import.meta.env.PUBLIC_STRAPI_URL || 'http://localhost:1337'}${logos.logoLight.data.attributes.url}`}
                alt={logos.logoLight.data.attributes.alternativeText || 'Logo'}
                class="h-12 md:h-16 w-auto object-contain logo-light"
                loading="eager"
              />
            )}
          </>
        ) : (
          <span class="text-[24px] md:text-[28px] font-normal leading-tight">
            <span class="block">SJD</span>
            <span class="block">Interior</span>
          </span>
        )}
      </a>

      <!-- Desktop Navigation - matching Figma -->
      <nav class="hidden lg:flex items-center gap-[19px]">
        {navItems.map((item) => (
          <a
            href={item.url}
            class:list={[
              'text-[15px] font-normal hover:opacity-70 transition-opacity header-link',
              currentPath === item.url ? 'opacity-70' : ''
            ]}
          >
            {item.label}
          </a>
        ))}
      </nav>

      <!-- CTA Button (Desktop) - Dynamic from Strapi -->
      <div class="hidden lg:block">
        {ctaConfig.type === 'whatsapp' ? (
          <a
            href={ctaUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center justify-center px-6 h-[45px] text-[15px] font-medium rounded-[22.5px] transition-all duration-300 header-cta-btn whitespace-nowrap"
          >
            {ctaConfig.text}
          </a>
        ) : (
          <a
            href={ctaUrl}
            class="inline-flex items-center justify-center px-6 h-[45px] text-[15px] font-medium rounded-[22.5px] transition-all duration-300 header-cta-btn whitespace-nowrap"
          >
            {ctaConfig.text}
          </a>
        )}
      </div>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-button"
        class="lg:hidden p-2 hover:text-primary transition-colors header-menu-btn"
        aria-label="Toggle mobile menu"
      >
        <svg class="w-6 h-6" id="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg class="w-6 h-6 hidden" id="close-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Menu - Premium Full Screen Overlay -->
  <nav
    id="mobile-menu"
    class="lg:hidden fixed inset-0 z-40 bg-black/95 backdrop-blur-xl transform translate-x-full transition-all duration-500 cubic-bezier(0.16, 1, 0.3, 1)"
    style="transition-timing-function: cubic-bezier(0.16, 1, 0.3, 1);"
  >
    <div class="h-full flex flex-col justify-center px-8 relative">
      <!-- Background Abstract Shape (Optional premium touch) -->
      <div class="absolute top-[-20%] right-[-10%] w-[300px] h-[300px] bg-primary/10 rounded-full blur-[100px] pointer-events-none"></div>

      <div class="space-y-6 md:space-y-8 flex flex-col items-center text-center">
        {navItems.map((item, index) => (
          <a
            href={item.url}
            class:list={[
              'mobile-nav-link text-[32px] md:text-[40px] font-light tracking-tight transition-all duration-300 transform translate-y-8 opacity-0',
              currentPath === item.url
                ? 'text-white font-normal'
                : 'text-[#888888] hover:text-white'
            ]}
            style={`transition-delay: ${100 + index * 50}ms`}
          >
            {item.label}
          </a>
        ))}

        <!-- Mobile CTA Button -->
        <div class="pt-8 w-full flex justify-center mobile-nav-link transform translate-y-8 opacity-0" style={`transition-delay: ${100 + navItems.length * 50}ms`}>
          {ctaConfig.type === 'whatsapp' ? (
            <a
              href={ctaUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center justify-center px-10 py-4 text-[18px] font-medium bg-white text-black rounded-full hover:bg-gray-200 transition-colors w-full max-w-[280px]"
            >
              {ctaConfig.text}
            </a>
          ) : (
            <a
              href={ctaUrl}
              class="inline-flex items-center justify-center px-10 py-4 text-[18px] font-medium bg-white text-black rounded-full hover:bg-gray-200 transition-colors w-full max-w-[280px]"
            >
              {ctaConfig.text}
            </a>
          )}
        </div>
      </div>

      <!-- Footer Info in Menu -->
      <div class="absolute bottom-10 left-0 right-0 text-center mobile-nav-link transform translate-y-8 opacity-0" style={`transition-delay: ${200 + navItems.length * 50}ms`}>
        <p class="text-[#666] text-sm font-light">
          &copy; {new Date().getFullYear()} SJD Interior Design
        </p>
      </div>
    </div>
  </nav>
</header>

<script>
  // Mobile menu toggle
  const menuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = document.getElementById('menu-icon');
  const closeIcon = document.getElementById('close-icon');
  const mobileLinks = document.querySelectorAll('.mobile-nav-link');

  let isMenuOpen = false;

  const toggleMenu = () => {
    isMenuOpen = !isMenuOpen;

    if (isMenuOpen) {
      // Open Menu
      mobileMenu?.classList.remove('translate-x-full');
      mobileMenu?.classList.add('translate-x-0');
      
      // Icon Animation
      menuIcon?.classList.add('hidden');
      closeIcon?.classList.remove('hidden');
      
      // Lock Body Scroll
      document.body.style.overflow = 'hidden';

      // Animate Links In
      setTimeout(() => {
        mobileLinks.forEach((link) => {
          link.classList.remove('translate-y-8', 'opacity-0');
        });
      }, 100);

    } else {
      // Close Menu
      mobileMenu?.classList.add('translate-x-full');
      mobileMenu?.classList.remove('translate-x-0');
      
      // Icon Animation
      menuIcon?.classList.remove('hidden');
      closeIcon?.classList.add('hidden');
      
      // Unlock Body Scroll
      document.body.style.overflow = '';

      // Reset Links (for next animation)
      mobileLinks.forEach((link) => {
        link.classList.add('translate-y-8', 'opacity-0');
      });
    }
  };

  menuButton?.addEventListener('click', toggleMenu);

  // Close mobile menu when clicking on a link
  mobileLinks.forEach(link => {
    link.addEventListener('click', () => {
      if (isMenuOpen) toggleMenu();
    });
  });

  // Close menu on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isMenuOpen) {
      toggleMenu();
    }
  });

  // Smart header background detection
  const header = document.getElementById('main-header');

  if (header) {
    // Function to check and update header
    const initializeHeader = () => {
      // Check if page has a hero section (image/banner at top)
      // Only look for explicit hero markers, not all sections
      const hasHeroSection = document.querySelector('[data-hero-section]');
      const shouldBeTransparent = !!hasHeroSection;

      const updateHeader = () => {
        const scrollY = window.scrollY;

        // If menu is open, force transparent (dark overlay covers it) or keep it consistent
        if (isMenuOpen) return;

        if (shouldBeTransparent) {
          // Page has hero - use transparent mode at top
          if (scrollY > 100) {
            header.classList.add('bg-white', 'shadow-sm');
            header.classList.remove('bg-transparent', 'bg-black/90');
          } else {
            header.classList.add('bg-transparent');
            header.classList.remove('bg-white', 'shadow-sm', 'bg-black/90');
          }
        } else {
          // No hero - always use white background
          header.classList.add('bg-white', 'shadow-sm');
          header.classList.remove('bg-transparent', 'bg-black/90');
        }
      };

      // Initial check
      updateHeader();

      // Listen to scroll events
      window.addEventListener('scroll', updateHeader, { passive: true });
    };

    // Run immediately and also after DOM is fully loaded
    initializeHeader();

    // Ensure it runs after all components are mounted
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeHeader);
    }
  }
</script>

<style>
  /* Cubic Bezier for smooth premium feel */
  .cubic-bezier {
    transition-timing-function: cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Header transitions */
  #main-header {
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
  }

  .header-logo,
  .header-link,
  .header-menu-btn {
    transition: color 0.3s ease;
  }

  /* Default state (Transparent background, White text) */
  #main-header.bg-transparent .header-logo,
  #main-header.bg-transparent .header-link,
  #main-header.bg-transparent .header-menu-btn {
    color: white;
  }

  #main-header.bg-transparent .header-link:hover {
    color: var(--color-primary, #0066ff);
  }

  /* Scrolled state (White background, Dark text) */
  #main-header.bg-white .header-logo,
  #main-header.bg-white .header-link,
  #main-header.bg-white .header-menu-btn {
    color: #1a1a1a;
  }

  #main-header.bg-white .header-link:hover {
    opacity: 0.7;
  }
  
  /* White button on transparent header */
  #main-header.bg-transparent .header-cta-btn {
    background-color: #ffffff;
    color: #000000;
  }

  #main-header.bg-transparent .header-cta-btn:hover {
    background-color: #f0f0f0;
  }

  /* Black button on scrolled header */
  #main-header.bg-white .header-cta-btn {
    background-color: #000000;
    color: #ffffff;
  }

  #main-header.bg-white .header-cta-btn:hover {
    background-color: #1a1a1a;
  }

  /* Logo switching based on header background */
  /* Both logos have identical dimensions to prevent layout shift */
  .logo-dark,
  .logo-light {
    transition: opacity 0.3s ease;
  }

  /* Default state (transparent background) - show light logo */
  #main-header.bg-transparent .logo-dark {
    opacity: 0;
    pointer-events: none;
  }

  #main-header.bg-transparent .logo-light {
    opacity: 1;
    pointer-events: auto;
  }

  /* Scrolled state (white background) - show dark logo */
  #main-header.bg-white .logo-dark {
    opacity: 1;
    pointer-events: auto;
  }

  #main-header.bg-white .logo-light {
    opacity: 0;
    pointer-events: none;
  }

  /* Fallback if only one logo exists */
  .header-logo-link:has(.logo-dark:only-child) .logo-dark,
  .header-logo-link:has(.logo-light:only-child) .logo-light {
    opacity: 1 !important;
    pointer-events: auto !important;
  }

  /* Ensure logos are positioned identically */
  .header-logo-link {
    display: inline-block;
  }

  .logo-dark.absolute {
    position: absolute;
  }
</style>
